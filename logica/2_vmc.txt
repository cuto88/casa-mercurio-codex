###############################################################################
# VMC 2100 — CORE LOGIC (mesh iperspettrale + orchestratore quantico)
###############################################################################

# LIVELLO OPERATIVO 2025 (impianto reale)
# ---------------------------------------------------------------------------
#   • Sensori disponibili tramite helper (`0_helpers_sensors.yaml`):
#       - `sensor.helper_hum_bath` (aggiungere negli helper partendo dal sensore reale)
#       - `sensor.helper_hum_zone_day` / `_zone_night`
#       - `sensor.helper_temp_zone_day` / `_zone_night`
#       - `sensor.helper_temp_outdoor` / `sensor.helper_hum_outdoor`
#       - `binary_sensor.helper_occupancy_zone_day` / `_zone_night`
#     Altri stati macchina (es. velocità VMC fisica) possono essere esposti come
#     `sensor.helper_vmc_speed_feedback` nello stesso file helper.
#   • Helper minimi: `input_boolean.vmc_override_off`, `input_boolean.vmc_boost_bagno`,
#     `input_number.vmc_timer_boost`, `input_boolean.vmc_freecooling_enabled`.
#   • Logiche attuabili subito:
#       - Boost bagno (P1) basato su UR ≥ soglia con anti-ciclo 10/5 min.
#       - Free-cooling base: se `T_out < T_in - 1.0 °C` e `UR_out < UR_in` → vel_2.
#       - Modalità notturna silenziosa (vel_1) come default, con fallback vel_0 se
#         sensori mancanti.
#       - Dashboard con card stato, override manuali e cronologia eventi.
#   • Implementazione: automazioni YAML standard + template sensori (ΔT, ΔUR,
#     IAQ, watchdog) definiti nel layer helper per disaccoppiare l'hardware.
#   • Orchestratore AI opzionale, ma non necessario per la prima messa in esercizio.
# ---------------------------------------------------------------------------

# ARCHITETTURA DELLE PRIORITÀ 2100
# ---------------------------------------------------------------------------
#   P-1) QUARANTENA BIOLOGICA       → vel_0 + sigillatura facciata
#   P0 ) FAILSAFE SENSORIALE        → vel_0 + loop diagnostico
#   OVERRIDE) Clima notte in DRY+   → vel_0 (coordinato con AC_N)
#   P1 ) BAGNO / BOOST NANO         → vel_3 (lock + isteresi biometrica)
#   P2 ) FREE-COOLING ENTALPICO     → vel_2 (branch: PASSIVHAUS / MACCHINA / PCM)
#   P3 ) INVERNO / ANTI-SECCO 2.0   → vel_0 + duty adattivo 5’/30’
#   P4 ) BASELINE RESPIRATORIO      → vel_1
#   P5 ) MODALITÀ IAQ PRIME         → vel_1.5 (ricircolo con scrubber)
#
# Arbitraggio: valutazione top-down; il primo stato TRUE prende controllo.
# P5 è valutato solo se P4 attivo da >60 min e IAQ-Q < 0.8.
# ---------------------------------------------------------------------------

###############################################################################
# [P-1] QUARANTENA BIOLOGICA
###############################################################################
# Trigger:
#   - binary_sensor.biohazard_alert TRUE (IAQ-Q < 0.4 + rilevazione patogeni)
#   - comandi della rete sanitaria cittadina (GraphQL push).
# Azioni:
#   → chiudi tutte le membrane, vel_0, attiva scrubber al plasma.
#   → forza duty 2’/15’ di ricircolo interno per mantenere IAQ.
# Uscita:
#   - quando alert = FALSE da ≥ 20 min e campioni aria OK.

###############################################################################
# [P0] FAILSAFE SENSORIALE
###############################################################################
# Se sensori non disponibili, errori o mismatch critici:
#   → forza vel_0 (modalità sicura) + richieste autodiagnostica.
# Gestito da binary_sensor.vmc_failsafe_sensors_bad (incluso controllo drift).
# Watchdog quantico: se nessuna condizione vera >10 min → fallback vel_1

###############################################################################
# [OVERRIDE] CLIMA NOTTE = DRY+
###############################################################################
# Condizione: AC zona notte in modalità DRY+ (deumidifica rigenerativa) attiva
#   → forza VMC vel_0, ma mantiene scrubber CO₂ a portata minima.
# Uscita override: quando AC notte esce da DRY+ oppure richiede aria nuova.
# Motivazione: evitare immissione aria umida e mantenere qualità del sonno.
# Priorità: immediatamente sotto P0, sopra P1/P2.

###############################################################################
# [P1] BAGNO / BOOST NANO
###############################################################################
Sensori: rete multispettrale bagno (UR, VOC, vapore) + camera nebulosa.
  Ingresso (start):
    - UR bagno ≥ 72%  OPPURE (UR bagno – UR esterna) ≥ 8%  OPPURE
      rilevazione VOC > soglia.
  Uscita (stop):
    - UR bagno ≤ 60%  E VOC entro soglia comfort 2100.
  Anti-ciclo:
    - LOCK minimo 8 minuti (ridotto grazie a ventilatori nanoflow).
    - COOLDOWN 4 minuti prima di ri-attivare.
  Cicli ripetuti (resistenza vapore):
    - Se in ≤ 25 min non si scende sotto 60% → 1 “ciclo” fallito.
    - Dopo 3 cicli falliti consecutivi:
        a) Se free-cooling favorevole → passa a vel_2 e apre serranda dedicata.
        b) Altrimenti richiedi AC in DRY+ su zona notte oppure attiva
           deumidificatore PCM interno, mantenendo VMC a vel_1.
        c) Dopo 15 min rivaluta P1 e P2.
  Note:
    - In fase BOOST, P1 scavalca P2–P5.
    - Log neurale con UR iniziale/finale, VOC e durata.

###############################################################################
# [P2] FREE-COOLING ENTALPICO (TRIPLICE)
###############################################################################

# --- 2.1 PASSIVHAUS+ (criteri PH con controllo latente + IAQ) ----------------
# ON se tutte vere:
#   - T_in > 24.0 °C
#   - T_out_eff < T_in - 0.4 °C (correzione per irraggiamento)
#   - AH_out_corr < AH_in - 0.4 g/m³
#   - IAQ esterna ≥ 0.7 e pollini < soglia utente.
# OFF se una qualsiasi condizione torna falsa o T_in ≤ 23.0 °C.
# Azione: → vel_2, attiva recupero entalpico inverso.
# Note: lock 12 min ad ogni ingresso, utilizza sensori multisorgente (media
# ponderata zone giorno/notte) e feed Meteo2100.

# --- 2.2 MACCHINA (criteri termici per compressori HVR) ---------------------
# ON se:
#   - T_in > 24.5 °C
#   - 19.5 °C < T_out < T_in
#   - Gradiente entalpico stimato > 3 kJ/kg.
# OFF se gradiente < 1.5 kJ/kg o T_out ≤ 19.5 °C.
# Azione: → vel_2, bypassa recuperatore.
# Note: lock 10 min, usa previsioni a 15 min per evitare cicli brevi.

# --- 2.3 PCM SYNC (raffreddamento con batteria termica) ---------------------
# ON se:
#   - Storage PCM disponibile (soc_pcm > 0.35)
#   - ΔT interno > 0.8 °C rispetto target
#   - Predizione comfort suggerisce scarico PCM entro 2 ore.
# OFF se soc_pcm < 0.2 o comfort raggiunto.
# Azione: → vel_2, abilita circuito aria attraverso scambiatori PCM.

# --- 2.4 Priorità interna ---------------------------------------------------
#   - PASSIVHAUS+ prevale su MACCHINA e PCM.
#   - Se PASSIVHAUS+ falsa ma PCM TRUE → PCM prevale su MACCHINA per ridurre carico.
#   - Se solo MACCHINA vera → usa MACCHINA.
#   - Se più modalità vere, logga la scelta nell’analisi IA.

###############################################################################
# [P3] INVERNO / ANTI-SECCO 2.0
###############################################################################
 Finestra temporale:
    - Mesi: novembre–marzo (11–3) oppure quando modalità “clima freddo” attiva.
    - Ore preferite: 22:30–06:30.
  Condizione:
    - sensor.helper_hum_internal_min ≤ 38% oppure comfort biometrico segnala secco.
    - Solo se P1 non attivo.
  Azione:
    - imposta vel_0 e attiva umidificazione passiva facciata.
    - duty-cycle adattivo: 4’ ON vel_1 ogni 26’ (modulato da IA).
  Uscita:
    - Fine finestra OR umidità risale > 40.5% OR richiesta aria nuova.

###############################################################################
# [P4] BASELINE RESPIRATORIO
###############################################################################
# Nessuna condizione attiva:
#   → vel_1 (ricambio minimo continuo, ~0.55 vol/h con filtro HEPA 2100)
# Funzione di fallback se watchdog segnala inattività logiche >10 min.

###############################################################################
# [P5] MODALITÀ IAQ PRIME
###############################################################################
# Condizione:
#   - IAQ-Q media < 0.8 per 60 min consecutivi mentre baseline attiva.
# Azione:
#   - Aumenta a vel_1.5, attiva scrubber VOC e filtri al grafene.
# Uscita:
#   - Quando IAQ-Q ≥ 0.85 per 15 min o altra priorità prende controllo.
#
# ROADMAP 2025 → 2100
#   1. Attivare priorità P1/P4 con sensori UR/T standard e verificare watchdog.
#   2. Estendere a P2 con template ΔT/ΔUR, quindi aggiungere sensori IAQ commerciali
#      (PM2.5/VOC) per gestire lock e boost automatici.
#   3. Integrare storage dati e notifiche per manutenzione filtri, quindi collegare
#      eventuali scambiatori/PCM.
#   4. Solo in fase avanzata introdurre sensori iperspettrali, feed sanitari e
#      orchestratore AI per quarantena e IAQ Prime.

FINE GUIDA 2100
===============================================================
